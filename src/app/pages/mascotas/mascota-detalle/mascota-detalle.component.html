<div class="app-fondo">
  <div class="app-contenido">

    <button mat-stroked-button (click)="volver()">← Volver a Mascotas</button>

    <mat-card *ngIf="mascota" class="info-mascota">
      <div class="info-header">
        <div>
          <h2>{{ mascota.mascota_nombre }}</h2>
          <p>
            {{ mascota.mascota_especie }} •
            {{ mascota.mascota_raza || 'Sin raza' }} •
            {{ mascota.mascota_sexo }}
          </p>
          <p>
            Dueño:
            {{ mascota.cliente_nombre }} {{ mascota.cliente_apellido }}
            ({{ mascota.cliente_cedula }})
          </p>
        </div>

        <img
          *ngIf="mascota.mascota_foto"
          [src]="'http://localhost:3000/api/mascotas/' + mascota.mascota_id + '/foto'"
          width="100" height="100"
          style="object-fit: cover; border-radius: 8px"
        />
      </div>
    </mat-card>

    <!-- Atenciones / Consultas -->
    <mat-card class="card-atenciones">
      <div class="titulo-acciones">
        <h3>Atenciones / Consultas</h3>
        <button mat-flat-button color="primary" (click)="nuevaAtencion()">
          + Nueva Atención
        </button>
      </div>

      <table mat-table [dataSource]="atenciones" class="mat-elevation-z8" *ngIf="atenciones.length">
        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let a">
            {{ (a.fecha_atencion || a.atencion_fecha) | date: 'shortDate' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="motivo">
          <th mat-header-cell *matHeaderCellDef>Motivo</th>
          <td mat-cell *matCellDef="let a">{{ a.motivo || a.motivo_consulta }}</td>
        </ng-container>

        <ng-container matColumnDef="diagnostico">
          <th mat-header-cell *matHeaderCellDef>Diagnóstico</th>
          <td mat-cell *matCellDef="let a">{{ a.diagnostico }}</td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let a">
            <button mat-icon-button color="primary" (click)="editarAtencion(a)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="eliminarAtencion(a)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnasAtenciones"></tr>
        <tr mat-row *matRowDef="let row; columns: columnasAtenciones"></tr>
      </table>

      <p *ngIf="atenciones.length === 0">
        Todavía no hay atenciones registradas.
      </p>
    </mat-card>

    <!-- Vacunas Aplicadas -->
    <mat-card class="card-atenciones">
      <div class="titulo-acciones">
        <h3>Vacunas Aplicadas</h3>
        <button mat-flat-button color="primary" (click)="nuevaVacuna()">
          + Aplicar Vacuna
        </button>
      </div>

      <table mat-table [dataSource]="vacunasAplicadas" class="mat-elevation-z8" *ngIf="vacunasAplicadas.length">
        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let v">
            {{ v.fecha_aplicacion | date: 'shortDate' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="vacuna">
          <th mat-header-cell *matHeaderCellDef>Vacuna</th>
          <td mat-cell *matCellDef="let v">
            {{ v.vacuna_nombre }}
          </td>
        </ng-container>

        <ng-container matColumnDef="lote">
          <th mat-header-cell *matHeaderCellDef>Lote</th>
          <td mat-cell *matCellDef="let v">
            {{ v.lote }}
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let v">
            <button mat-icon-button color="primary" (click)="editarVacuna(v)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="eliminarVacuna(v)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnasVacunas"></tr>
        <tr mat-row *matRowDef="let row; columns: columnasVacunas"></tr>
      </table>

      <p *ngIf="vacunasAplicadas.length === 0">
        Esta mascota aún no tiene vacunas registradas.
      </p>
    </mat-card>

    <!-- Desparasitaciones Aplicadas -->
    <mat-card class="card-atenciones">
      <div class="titulo-acciones">
        <h3>Desparasitaciones Aplicadas</h3>
        <button mat-flat-button color="primary" (click)="nuevaDesparasitacion()">
          + Aplicar Desparasitación
        </button>
      </div>

      <table mat-table [dataSource]="desparasitaciones" class="mat-elevation-z8" *ngIf="desparasitaciones.length">
        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let d">
            {{ d.fecha_aplicacion | date: 'shortDate' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="producto">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let d">
            {{ d.desparasitante_nombre || d.nombre_desparasitante }}
          </td>
        </ng-container>

        <ng-container matColumnDef="dosis">
          <th mat-header-cell *matHeaderCellDef>Dosis</th>
          <td mat-cell *matCellDef="let d">
            {{ d.dosis }}
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let d">
            <button mat-icon-button color="primary" (click)="editarDesparasitacion(d)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="eliminarDesparasitacion(d)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnasDesparasitaciones"></tr>
        <tr mat-row *matRowDef="let row; columns: columnasDesparasitaciones"></tr>
      </table>

      <p *ngIf="desparasitaciones.length === 0">
        Esta mascota aún no tiene desparasitaciones registradas.
      </p>
    </mat-card>
    <!-- ================= TRATAMIENTOS ================= -->
<section class="bloque">
  <div class="bloque-header">
    <h3>Tratamientos</h3>
    <button mat-stroked-button color="primary" (click)="toggleFormTratamiento()">
      {{ mostrandoFormTratamiento ? 'Cancelar' : '+ Nuevo Tratamiento' }}
    </button>
  </div>

  <form
    *ngIf="mostrandoFormTratamiento"
    (ngSubmit)="guardarTratamiento()"
    #tratForm="ngForm"
    class="form-tratamiento">

    <label>
      Tratamiento:
      <select
        required
        name="tratamiento_id"
        [(ngModel)]="nuevoTratamiento.tratamiento_id">
        <option value="" disabled selected>Seleccione...</option>
        <option *ngFor="let t of catalogoTratamientos" [value]="t.tratamiento_id">
          {{ t.tratamiento_nombre }}
        </option>
      </select>
    </label>

    <label>
      Dosis:
      <input type="text" name="dosis" [(ngModel)]="nuevoTratamiento.dosis">
    </label>

    <label>
      Frecuencia:
      <input type="text" name="frecuencia" [(ngModel)]="nuevoTratamiento.frecuencia">
    </label>

    <label>
      Inicio:
      <input type="date" name="fecha_inicio" [(ngModel)]="nuevoTratamiento.fecha_inicio">
    </label>

    <label>
      Fin:
      <input type="date" name="fecha_fin" [(ngModel)]="nuevoTratamiento.fecha_fin">
    </label>

    <button
      mat-flat-button
      color="primary"
      type="submit"
      [disabled]="tratForm.invalid">
      Guardar
    </button>
  </form>

  <table
    mat-table
    [dataSource]="tratamientosMascota"
    class="mat-elevation-z8"
    *ngIf="tratamientosMascota.length">

    <ng-container matColumnDef="nombre">
      <th mat-header-cell *matHeaderCellDef>Tratamiento</th>
      <td mat-cell *matCellDef="let tr">{{ tr.tratamiento_nombre }}</td>
    </ng-container>

    <ng-container matColumnDef="dosis">
      <th mat-header-cell *matHeaderCellDef>Dosis</th>
      <td mat-cell *matCellDef="let tr">{{ tr.dosis }}</td>
    </ng-container>

    <ng-container matColumnDef="frecuencia">
      <th mat-header-cell *matHeaderCellDef>Frecuencia</th>
      <td mat-cell *matCellDef="let tr">{{ tr.frecuencia }}</td>
    </ng-container>

    <ng-container matColumnDef="periodo">
      <th mat-header-cell *matHeaderCellDef>Período</th>
      <td mat-cell *matCellDef="let tr">
        {{ tr.fecha_inicio | date:'dd/MM/yy' }} -
        {{ tr.fecha_fin    | date:'dd/MM/yy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="estado">
      <th mat-header-cell *matHeaderCellDef>Estado</th>
      <td mat-cell *matCellDef="let tr">{{ tr.estado }}</td>
    </ng-container>

    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let tr">
        <button mat-icon-button color="warn" (click)="eliminarTratamiento(tr.mascotaTratamiento_id)">
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="['nombre','dosis','frecuencia','periodo','estado','acciones']"></tr>
    <tr mat-row *matRowDef="let row; columns: ['nombre','dosis','frecuencia','periodo','estado','acciones'];"></tr>
  </table>

  <p *ngIf="!tratamientosMascota.length">
    No hay tratamientos registrados para esta mascota.
  </p>
</section>


  </div>
</div>
