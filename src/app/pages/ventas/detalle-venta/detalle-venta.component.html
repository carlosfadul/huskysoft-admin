<!-- src/app/pages/ventas/detalle-venta/detalle-venta.component.html -->

<h2>Detalle de venta #{{ ventaId }}</h2>

<p *ngIf="venta">
  <strong>Cliente ID:</strong> {{ venta.cliente_id }} |
  <strong>Fecha:</strong> {{ venta.venta_fecha | date:'short' }} |
  <strong>Estado:</strong> {{ venta.venta_estado }} |
  <strong>Total:</strong> {{ venta.total | currency:'COP':'symbol':'1.0-0' }}
</p>

<div class="acciones">
  <button mat-raised-button color="primary" (click)="abrirFormularioDetalle()">
    <mat-icon>add</mat-icon>
    Agregar producto
  </button>
</div>

<table
  mat-table
  [dataSource]="dataSource"
  class="mat-elevation-z8 full-width-table"
  *ngIf="dataSource.data.length"
>

  <ng-container matColumnDef="detalleVenta_id">
    <th mat-header-cell *matHeaderCellDef>#</th>
    <td mat-cell *matCellDef="let d">{{ d.detalleVenta_id }}</td>
  </ng-container>

  <ng-container matColumnDef="producto_id">
    <th mat-header-cell *matHeaderCellDef>ID Producto</th>
    <td mat-cell *matCellDef="let d">{{ d.producto_id }}</td>
  </ng-container>

  <ng-container matColumnDef="detalleVenta_cantidad">
    <th mat-header-cell *matHeaderCellDef>Cantidad</th>
    <td mat-cell *matCellDef="let d">{{ d.detalleVenta_cantidad }}</td>
  </ng-container>

  <ng-container matColumnDef="detalleVenta_precio">
    <th mat-header-cell *matHeaderCellDef>Precio</th>
    <td mat-cell *matCellDef="let d">
      {{ d.detalleVenta_precio | currency:'COP':'symbol':'1.0-0' }}
    </td>
  </ng-container>

  <ng-container matColumnDef="descuento">
    <th mat-header-cell *matHeaderCellDef>Desc (%)</th>
    <td mat-cell *matCellDef="let d">{{ d.descuento ?? 0 }}</td>
  </ng-container>

  <ng-container matColumnDef="subtotal">
    <th mat-header-cell *matHeaderCellDef>Subtotal</th>
    <td mat-cell *matCellDef="let d">
      {{ d.subtotal | currency:'COP':'symbol':'1.0-0' }}
    </td>
  </ng-container>

  <ng-container matColumnDef="acciones">
    <th mat-header-cell *matHeaderCellDef>Acciones</th>
    <td mat-cell *matCellDef="let d">
      <button mat-icon-button color="primary" (click)="abrirFormularioDetalle(d)">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button color="warn" (click)="eliminarDetalle(d)">
        <mat-icon>delete</mat-icon>
      </button>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="columnas"></tr>
  <tr mat-row *matRowDef="let row; columns: columnas;"></tr>
</table>

<p *ngIf="!dataSource.data.length && !loading">
  No hay detalles registrados para esta venta.
</p>

<!-- Template del formulario de detalle -->
<ng-template #detalleFormTemplate>
  <h2 mat-dialog-title>
    {{ editandoDetalle ? 'Editar detalle' : 'Nuevo detalle' }}
  </h2>

  <div mat-dialog-content [formGroup]="detalleForm" class="form-container">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>ID Producto</mat-label>
      <input matInput type="number" formControlName="producto_id" />
    </mat-form-field>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Cantidad</mat-label>
      <input matInput type="number" formControlName="detalleVenta_cantidad" />
    </mat-form-field>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Precio</mat-label>
      <input matInput type="number" formControlName="detalleVenta_precio" />
    </mat-form-field>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Descuento (%)</mat-label>
      <input matInput type="number" formControlName="descuento" />
    </mat-form-field>
  </div>

  <div mat-dialog-actions align="end">
    <button mat-button (click)="dialogRef?.close()">Cancelar</button>
    <button mat-raised-button color="primary" (click)="guardarDetalle()" [disabled]="detalleForm.invalid">
      Guardar
    </button>
  </div>
</ng-template>
