<h2 mat-dialog-title>{{ titulo }}</h2>

<div mat-dialog-content [formGroup]="form" class="atencion-form">

  <!-- Servicio -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Servicio*</mat-label>
    <mat-select formControlName="servicio_id">
      <mat-option *ngFor="let s of servicios" [value]="s.servicio_id">
        {{ s.servicio_nombre || s.nombre_servicio || s.nombre }}
      </mat-option>
    </mat-select>
    <mat-error *ngIf="form.get('servicio_id')?.hasError('required')">
      El servicio es obligatorio
    </mat-error>
  </mat-form-field>

  <div class="row">
    <!-- Fecha -->
    <mat-form-field appearance="outline">
      <mat-label>Fecha de atención*</mat-label>
      <input matInput [matDatepicker]="pickerFecha" formControlName="atencion_fecha">
      <mat-datepicker-toggle matSuffix [for]="pickerFecha"></mat-datepicker-toggle>
      <mat-datepicker #pickerFecha></mat-datepicker>
    </mat-form-field>

    <!-- Cantidad -->
    <mat-form-field appearance="outline">
      <mat-label>Cantidad*</mat-label>
      <input matInput type="number" formControlName="atencion_cantidad" min="1">
    </mat-form-field>

    <!-- Precio -->
    <mat-form-field appearance="outline">
      <mat-label>Precio*</mat-label>
      <input matInput type="number" formControlName="atencion_precio" min="0" step="0.01">
    </mat-form-field>
  </div>

  <!-- Motivo -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Motivo de la atención*</mat-label>
    <textarea matInput rows="2" formControlName="atencion_motivo"></textarea>
    <mat-error *ngIf="form.get('atencion_motivo')?.hasError('required')">
      El motivo es obligatorio
    </mat-error>
  </mat-form-field>

  <!-- Detalle -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Detalle de la atención</mat-label>
    <textarea matInput rows="2" formControlName="atencion_detalle"></textarea>
  </mat-form-field>

  <!-- Diagnóstico -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Diagnóstico</mat-label>
    <textarea matInput rows="2" formControlName="diagnostico"></textarea>
  </mat-form-field>

  <!-- Tratamiento desde tabla Tratamiento -->
  <div class="row">
    <mat-form-field appearance="outline">
      <mat-label>Tratamiento (catálogo)</mat-label>
      <mat-select formControlName="tratamiento_id">
        <mat-option [value]="null">Sin tratamiento</mat-option>
        <mat-option *ngFor="let t of tratamientos" [value]="t.tratamiento_id">
          {{ t.tratamiento_nombre }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tratamiento (texto)</mat-label>
      <textarea matInput rows="1" formControlName="tratamiento_texto"></textarea>
    </mat-form-field>
  </div>

  <!-- Observaciones -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Observaciones</mat-label>
    <textarea matInput rows="2" formControlName="observaciones"></textarea>
  </mat-form-field>

  <!-- Estado -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Estado*</mat-label>
    <mat-select formControlName="atencion_estado">
      <mat-option value="pendiente">Pendiente</mat-option>
      <mat-option value="completada">Completada</mat-option>
      <mat-option value="cancelada">Cancelada</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Archivo adjunto -->
  <div class="file-input">
    <label for="archivo">Adjuntar archivo (imagen de examen, foto, etc.)</label>
    <input id="archivo" type="file" (change)="onFileSelected($event)" accept="image/*">
    <small *ngIf="archivoSeleccionado">
      Archivo seleccionado: {{ archivoSeleccionado.name }}
    </small>
  </div>

</div>

<div mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancelar()">Cancelar</button>
  <button mat-flat-button color="primary" (click)="guardar()" [disabled]="form.invalid">
    Guardar
  </button>
</div>

