<!-- src/app/components/venta-form/venta-form.component.html -->

<h2 mat-dialog-title>{{ titulo }}</h2>

<div mat-dialog-content [formGroup]="form" class="form-container">
  <!-- Cliente -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Cliente</mat-label>
    <mat-select formControlName="cliente_id" required>
      <mat-option *ngFor="let c of clientes" [value]="c.cliente_id">
        {{ c.cliente_nombre }} {{ c.cliente_apellido }} ({{ c.cliente_cedula }})
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Fecha de venta -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Fecha de venta</mat-label>
    <input
      matInput
      [matDatepicker]="picker"
      formControlName="venta_fecha"
      required
    />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>

  <!-- Estado -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Estado</mat-label>
    <mat-select formControlName="venta_estado" required>
      <mat-option *ngFor="let e of estados" [value]="e">
        {{ e }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Método de pago -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Método de pago</mat-label>
    <mat-select formControlName="metodo_pago" required>
      <mat-option *ngFor="let m of metodosPago" [value]="m">
        {{ m }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Detalles -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Detalles</mat-label>
    <textarea matInput rows="3" formControlName="venta_detalles"></textarea>
  </mat-form-field>

  <!-- Sección de productos -->
  <div class="items-header">
    <h3>Productos</h3>
    <button mat-stroked-button type="button" (click)="agregarItem()">
      + Agregar producto
    </button>
  </div>

  <table class="items-table" *ngIf="items.length > 0">
    <thead>
      <tr>
        <th style="width: 35%">Producto</th>
        <th style="width: 12%">Cant.</th>
        <th style="width: 15%">Precio</th>
        <th style="width: 15%">Desc. %</th>
        <th style="width: 18%">Subtotal</th>
        <th style="width: 5%"></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let it of items; let i = index">
        <td>
          <mat-form-field appearance="fill" class="full-width">
            <mat-select
              [value]="it.producto_id"
              (selectionChange)="it.producto_id = $event.value; onProductoChange(it)"
            >
              <mat-option *ngFor="let p of productos" [value]="p.producto_id">
                {{ p.nombre_producto }} (Stock: {{ p.cantidad_producto }})
              </mat-option>
            </mat-select>
          </mat-form-field>
        </td>

        <td>
          <mat-form-field appearance="fill">
            <input
              matInput
              type="number"
              min="1"
              [(ngModel)]="it.cantidad"
              (ngModelChange)="onCantidadOrDescuentoChange(it)"
            />
          </mat-form-field>
        </td>

        <td>
          <mat-form-field appearance="fill">
            <input
              matInput
              type="number"
              [value]="it.precio"
              readonly
            />
          </mat-form-field>
        </td>

        <td>
          <mat-form-field appearance="fill">
            <input
              matInput
              type="number"
              min="0"
              max="100"
              [(ngModel)]="it.descuento"
              (ngModelChange)="onCantidadOrDescuentoChange(it)"
            />
          </mat-form-field>
        </td>

        <td>
          <mat-form-field appearance="fill">
            <input
              matInput
              type="number"
              [value]="it.subtotal | number:'1.2-2'"
              readonly
            />
          </mat-form-field>
        </td>

        <td class="items-acciones">
          <button
            mat-icon-button
            color="warn"
            type="button"
            (click)="eliminarItem(i)"
          >
            ✕
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Totales visibles -->
  <div class="resumen-totales">
    <div>Subtotal: {{ form.value.subtotal | number:'1.2-2' }}</div>
    <div>Impuestos: {{ form.value.impuestos | number:'1.2-2' }}</div>
    <div>Descuentos: {{ form.value.descuentos | number:'1.2-2' }}</div>
    <div><strong>Total: {{ form.value.total | number:'1.2-2' }}</strong></div>
  </div>
</div>

<div mat-dialog-actions align="end">
  <button mat-button type="button" (click)="cancelar()">Cancelar</button>
  <button
    mat-raised-button
    color="primary"
    type="button"
    (click)="guardar()"
    [disabled]="guardando || form.invalid"
  >
    Guardar
  </button>
</div>

